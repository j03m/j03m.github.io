<h1 id="this-blog-wrote-itself-">THIS BLOG WROTE ITSELF!</h1>
<p>Well, no it didn&#39;t. But this blog for all intents an purposes created by the
tools it aims to describe and serves as an outline as to how a server-less blog
can be created using github.io for hosting, nodejs and gulp.</p>
<p>I immediately dug the instantness of github.io. Being pretty bare bones though
I was initially woed by Jekyll. About a quarter of the way into the instructions
though, I found myself saying. You know what - you&#39;ve done so little web stuff
in recent days. Why don&#39;t you take a moment and build it out yourself?</p>
<p>The first thing I knew is I wanted to write in my editor of choice using
Markdown because, well, Markdown is fast, fluent, easy and we all know it well
from creating github README.mds. I had no interest in web based editors. I tried
Medium and couldn&#39;t figure out a way to format a code snippet that could compete
with Github&#39;s very simple &amp;#96&amp;#96&amp;#96javascript.</p>
<p>I also wanted the site to be pretty and have some neat features that I could
code myself. This would also (in theory) allow me to build the scaffolding of
the site to taste, force me to brush up my CSS skills and generally let me have
a place to drop new client side web tech without much overhead. (I&#39;m sure at
some point I&#39;ll need a server, but we&#39;ll see).</p>
<p>I also didn&#39;t want to host a backend and I want to push and revise content in git.
Obviously github.io is the perfect fit, but I wanted to build up a scaffolding
that let me publish as easily as deploying code. I also wanted to be able to
save drafts and review them locally before pushing.</p>
<p>The plan seemed simple: Create a set of gulp scripts that converted md files to blog posts.
Host the blog locally so I could see live updates and use git to manage version. What could go wrong?</p>
<p>So the first post in this blog is how I built this blog. One of my favorite
blog of all time both for content, layout and style is <a href="www.substack.net">www.substack.net</a>
(which is also gitpowered, but I still want to write my own), so I&#39;ll pattern off of
that for general usability and coolness. (Imitation is the the most sincere form of flattery?)
We&#39;ll have a scrolling lists of posts and click through to view the full post.</p>
<p>So off to the races.</p>
<h2 id="first-things-first-easy-markdown-to-html-">First things first: <em>Easy markdown to html</em></h2>
<p>(<a href="https://github.com/chjj/marked)[chjj/marked">https://github.com/chjj/marked)[chjj/marked</a>] stood out here
as my best option for node as the syntax highlighting sample was simple to follow
and if I don&#39;t have syntax hilighting then I know down the line I&#39;m going to be
sad.</p>
<p>(I guess we&#39;ll put that to the test now, with a github style code bracket)</p>
<p>First we install some prereqs and end up with an already impressively long
package.json:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;j03m.github.io&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;J03m&#39;s blog. &quot;</span><span class="p">,</span>
  <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;index.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;test&quot;</span><span class="o">:</span> <span class="s2">&quot;none&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;repository&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;git&quot;</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="s2">&quot;https://github.com/j03m/j03m.github.io&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;keywords&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;j03m&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;j03m&quot;</span><span class="p">,</span>
  <span class="s2">&quot;license&quot;</span><span class="o">:</span> <span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
  <span class="s2">&quot;bugs&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="s2">&quot;https://github.com/j03m/j03m.github.io/issues&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;homepage&quot;</span><span class="o">:</span> <span class="s2">&quot;https://github.com/j03m/j03m.github.io&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;bluebird&quot;</span><span class="o">:</span> <span class="s2">&quot;^2.9.24&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marked&quot;</span><span class="o">:</span> <span class="s2">&quot;^0.3.3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pygmentize-bundled&quot;</span><span class="o">:</span> <span class="s2">&quot;^2.3.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;yargs&quot;</span><span class="o">:</span> <span class="s2">&quot;^3.7.0&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>You can google the depedencies I used, but basically this handles promises, md
conversion, syntax highlighting and cli options.</p>
<p>Okay and marked is installed. So at this point I decided I&#39;d start writing some
really simple commandline style scripts for blog actions and eventually wire
them together with gulp for watching markdowns, transforming and pushing branches
with gitjs.</p>
<p>But I&#39;m getting ahead of myself. Let&#39;s test some write some js code that will
generate this post and see how it looks. This is almost mind blowing.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="err">#</span><span class="o">!</span><span class="err">/usr/bin/env node</span>
<span class="kd">var</span> <span class="nx">marked</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;marked&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pygmentize-bundled&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bluebird&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fsp</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">fs</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">markedP</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">marked</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pbp</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">pb</span><span class="p">);</span>


<span class="kd">function</span> <span class="nx">md2post</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">marked</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>
        <span class="nx">renderer</span><span class="o">:</span> <span class="k">new</span> <span class="nx">marked</span><span class="p">.</span><span class="nx">Renderer</span><span class="p">(),</span>
        <span class="nx">gfm</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">tables</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">breaks</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">pedantic</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">sanitize</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">smartLists</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">smartypants</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">highlight</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">lang</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pbp</span><span class="p">({</span><span class="nx">lang</span><span class="o">:</span> <span class="nx">lang</span><span class="p">,</span> <span class="nx">format</span><span class="o">:</span> <span class="s1">&#39;html&#39;</span><span class="p">},</span> <span class="nx">code</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
            <span class="p">});</span> <span class="c1">//crash on reject</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">markedP</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">md2post</span> <span class="o">=</span> <span class="nx">md2post</span><span class="p">;</span>


<span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fsp</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="nx">input</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">rawFile</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">md2post</span><span class="p">(</span><span class="nx">rawFile</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileAsync</span><span class="p">(</span><span class="nx">output</span><span class="p">,</span> <span class="nx">html</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">;</span>


<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">argv</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;yargs&#39;</span><span class="p">).</span><span class="nx">usage</span><span class="p">(</span><span class="s1">&#39;Usage: $0 --input [path to input file] --output [path to output file]&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">demand</span><span class="p">([</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">])</span>
        <span class="p">.</span><span class="nx">argv</span><span class="p">;</span>
    <span class="nx">transform</span><span class="p">(</span><span class="nx">argv</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="nx">argv</span><span class="p">.</span><span class="nx">output</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Success!&quot;</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Failed:&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>So now we have a command line util + module that will do our markdown to html transformations. Exciting.</p>
<p>A quick:</p>
<pre><code><div class="highlight"><pre><span class="o">&gt;</span> <span class="nx">chmod</span> <span class="nx">u</span><span class="o">+</span><span class="nx">x</span> <span class="nx">md2post</span><span class="p">.</span><span class="nx">js</span>
<span class="o">&gt;</span> <span class="p">.</span><span class="o">/</span><span class="nx">md2post</span><span class="p">.</span><span class="nx">js</span> <span class="o">--</span><span class="nx">input</span> <span class="nx">BuildingThisBlog</span><span class="p">.</span><span class="nx">md</span> <span class="o">--</span><span class="nx">output</span> <span class="nx">out</span><span class="p">.</span><span class="nx">html</span>
</pre></div>

</code></pre><p>Verifies that we indeed have some purty html (look familiar?):</p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="nt">&lt;p&gt;</span>I immediately dug the instant-ness of github.io. Being pretty bare bones though
I was initially woo-ed by Jekyll. About a quarter of the way into the instructions
though, I found myself saying. You know what - you<span class="ni">&amp;#39;</span>ve done so little web stuff
in recent days. Why don<span class="ni">&amp;#39;</span>t you take a moment and build it out yourself?<span class="nt">&lt;/p&gt;</span>
</pre></div>

</code></pre>
<h2 id="testing">Testing</h2>
<p>To verify that we don&#39;t break things moving forward, let&#39;s be good citizens and
write some tests. For that I like mocha, which we&#39;ll add to our deps:</p>
<pre><code><div class="highlight"><pre><span class="o">&gt;</span> <span class="nx">npm</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">g</span> <span class="nx">mocha</span>
</pre></div>

</code></pre><p>For our test, we&#39;ll keep it simple and only test the transform method. To do this
though we have a physical dependency on fs, which will make things hard to test.
To inject that without having to monkey around with a proper dependency injection
pattern, we&#39;ll use rewire.</p>
<pre><code><div class="highlight"><pre><span class="o">&gt;</span> <span class="nx">npm</span> <span class="nx">install</span> <span class="nx">rewire</span> <span class="o">--</span><span class="nx">save</span><span class="o">-</span><span class="nx">dev</span>
</pre></div>

</code></pre><p>Then a really simple test. We&#39;ll grab a fragment from the marked tests, since
we&#39;re not trying to verify it&#39;s ability to parse markdown, only that our code
paths work. And then we&#39;ll write a simple test that verifies promise rejection on
file input.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">rewire</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rewire&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;assert&quot;</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;bluebird&quot;</span><span class="p">);</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;md2post&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;transforms&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;success write a file&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">md2post</span> <span class="o">=</span> <span class="nx">rewire</span><span class="p">(</span><span class="s2">&quot;../lib/md2post.js&quot;</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="s2">&quot;inputfile.md&quot;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s2">&quot;outputfile.md&quot;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">fsMock</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">readFileAsync</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span><span class="nx">r</span><span class="p">){</span>
                        <span class="nx">assert</span><span class="p">(</span><span class="nx">path</span><span class="o">===</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;Input path should be correct&quot;</span><span class="p">);</span>
                        <span class="nx">f</span><span class="p">(</span><span class="s2">&quot;Paragraph. &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;\n&gt; * bq Item 1 &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;\n&gt; * bq Item 2 &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;\n&gt;   * New bq Item 1 &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;\n&gt;   * New bq Item 2 &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;\n&gt;   Text here &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;\n&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;\n* * *&quot;</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">},</span>
                <span class="nx">writeFileAsync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span><span class="nx">r</span><span class="p">){</span>
                        <span class="nx">assert</span><span class="p">(</span><span class="nx">path</span><span class="o">==</span><span class="nx">output</span><span class="p">,</span> <span class="s2">&quot;Output path should be correct&quot;</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">expected</span> <span class="o">=</span> <span class="s2">&quot;&lt;p&gt;Paragraph. &lt;/p&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;blockquote&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;ul&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;li&gt;bq Item 1 &lt;/li&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;li&gt;bq Item 2 &lt;ul&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;li&gt;New bq Item 1 &lt;/li&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;li&gt;New bq Item 2 \n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;Text here &lt;/li&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;/ul&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;/li&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;/ul&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;/blockquote&gt;\n&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;&lt;hr&gt;\n&quot;</span><span class="p">;</span>

                        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">expected</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">expected</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]){</span>
                                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Diff at char:&quot;</span><span class="p">,</span><span class="nx">i</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span>

                        <span class="nx">assert</span><span class="p">(</span><span class="nx">data</span><span class="o">===</span><span class="nx">expected</span><span class="p">,</span><span class="s2">&quot;Output should be correct&quot;</span><span class="p">);</span>
                        <span class="nx">f</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                        <span class="nx">done</span><span class="p">();</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">};</span>
            <span class="nx">md2post</span><span class="p">.</span><span class="nx">__set__</span><span class="p">(</span><span class="s2">&quot;fsp&quot;</span><span class="p">,</span> <span class="nx">fsMock</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">md2post</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span><span class="nx">output</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;file failures reject properly&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">md2post</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/md2post.js&quot;</span><span class="p">);</span> <span class="c1">//no dep stub needed</span>
            <span class="nx">md2post</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="s2">&quot;fake&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                <span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
            <span class="p">}).</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
                <span class="nx">assert</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                <span class="nx">done</span><span class="p">();</span>
            <span class="p">})</span>
        <span class="p">});</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<h2 id="the-bigger-picture">The bigger picture</h2>
<p>Okay, but now I knew I needed a way to manage posts. Some method for organizing
and indexing them. What we&#39;ll do here is follow a simple scheme of title/index.html
for post locations. Then we&#39;ll create a scheme for creating an index that we&#39;ll
use to fetch additional posts on scroll. Last we&#39;ll generate a site map and
submit it to google. After that, we&#39;ll wire up gulp command for generating
all this stuff on the fly.</p>
<p>Let&#39;s do some stuff with gulp file watchers. Now, we&#39;ll set up gulp to monitor
a posts directory for changes. When it detects one it will convert the modified
files to html and store them in a directory named for the title and index.html.</p>
<p>Doing that will give us the naming structure domain/post-title-text. Installing
gulp:</p>
<pre><code><div class="highlight"><pre><span class="nx">npm</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">g</span> <span class="nx">gulp</span>
<span class="nx">npm</span> <span class="nx">install</span> <span class="nx">gulp</span> <span class="o">--</span><span class="nx">save</span><span class="o">-</span><span class="nx">dev</span>
</pre></div>

</code></pre><p>Next, we&#39;ll create a basic gulp file watch and watch our &quot;raws&quot; directory which
will contain raw mds. We&#39;ll also watch lib and test and cause modifications
there to trigger mocha. For this we&#39;ll use gulp.watch and gulp-mocha.</p>
<pre><code><div class="highlight"><pre><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">gulp</span><span class="o">-</span><span class="nx">mocha</span> <span class="o">--</span><span class="nx">save</span><span class="o">-</span><span class="nx">dev</span>
</pre></div>

</code></pre><p>Our initial skeleton GulpFile.js looks like:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">watch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-watch&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">batch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-batch&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">mocha</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-mocha&#39;</span><span class="p">);</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Testing!&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;build_content&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Building!&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;lib/**/*.js&#39;</span><span class="p">,</span> <span class="nx">batch</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">gulp</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">);</span>
    <span class="p">}));</span>

    <span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;tests/**/*.js&#39;</span><span class="p">,</span> <span class="nx">batch</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">gulp</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">);</span>
    <span class="p">}));</span>

    <span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;raws/**/*.md&#39;</span><span class="p">,</span> <span class="nx">batch</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">gulp</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">&#39;build_content&#39;</span><span class="p">);</span>
    <span class="p">}));</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>We can edit raws and lib to verify we see the correct console output. But,
we need some real code in there to do some real stuff. Wiring tests is easy well
use the gulp-mocha plugin and use gulp.watch to trigger it off of changes to
our lib or tests directory.</p>
<p>For building content, we&#39;ll need another target command that will leverage
md2post.js. Streams hurt my head and I find them opaque but I suppose there is
no arguing the hard performance benefits. To get around my personal brain power
limitations I&#39;m going to use through2 which allows me think in terms of
functional blocks but still get the benefit of streaming.</p>
<p>Here, we&#39;ll create a function called processMdFiles that will get passed to
through2 and used in our &quot;build_content&quot; task. The function cheats a bit,
operates converts the buffer from our vinyl file to a string, transforms and
then rebuffers it. As a later project we&#39;ll see if we can get marked working
with streams. I suppose we should have looked or written a gulp-marked plugin,
but this will suffice for now.</p>
<p>Our final gulp file looks like:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">mocha</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-mocha&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">tap</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-tap&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">rename</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-rename&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">through2</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;through2&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">md2post</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/md2post.js&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>


<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;tests/**/*.js&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">read</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">mocha</span><span class="p">({</span><span class="nx">reporter</span><span class="o">:</span> <span class="s1">&#39;nyan&#39;</span><span class="p">}));</span>
<span class="p">});</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;build_content&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;raws/**/*.md&#39;</span><span class="p">)</span>
        <span class="c1">// tap into the stream to get each file&#39;s data</span>
        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">processMdFiles</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s2">&quot;./dist&quot;</span><span class="p">))</span>
<span class="p">});</span>


<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;lib/**/*.js&#39;</span><span class="p">,[</span><span class="s1">&#39;test&#39;</span><span class="p">]);</span>
    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;tests/**/*.js&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]);</span>
    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;raws/**/*.md&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;build_content&#39;</span><span class="p">]);</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">processMdFiles</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">enc</span><span class="p">,</span> <span class="nx">cb</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">md2post</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
        <span class="nx">chunk</span><span class="p">.</span><span class="nx">contents</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
        <span class="nx">cb</span><span class="p">();</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

<span class="p">}</span>
</pre></div>

</code></pre>
<p>Now, as I save this blog post, an equivalent file is written to ./dist but is
formatted with html. This is cool, but I don&#39;t want
to write to ./dist/filename.md. I actually want to take the post name, create a directory
and then inside place an index.html file. After that I&#39;ll need to start thinking
about the main index and what our blog template will look like.</p>
<p>Gulp-rename passed a function lets us do the path swap pretty easily. Our
build_content task turns into:</p>
<pre><code><div class="highlight"><pre><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;build_content&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;raws/**/*.md&#39;</span><span class="p">)</span>
        <span class="c1">// tap into the stream to get each file&#39;s data</span>
        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">processMdFiles</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="nx">newPath</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s2">&quot;./dist&quot;</span><span class="p">))</span>
<span class="p">});</span>
</pre></div>

</code></pre><p>With this function handling the rename details:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">newPath</span><span class="p">(</span><span class="nx">pathObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pathObj</span><span class="p">.</span><span class="nx">dirname</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">pathObj</span><span class="p">.</span><span class="nx">dirname</span><span class="p">,</span> <span class="nx">pathObj</span><span class="p">.</span><span class="nx">basename</span><span class="p">)</span>
    <span class="nx">pathObj</span><span class="p">.</span><span class="nx">basename</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">;</span>
    <span class="nx">pathObj</span><span class="p">.</span><span class="nx">extname</span> <span class="o">=</span> <span class="s2">&quot;.html&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="the-even-bigger-picture">The even bigger picture</h2>
<p>Next up I needed to figure out what I wanted to do about an index. I didn&#39;t know
much about SEO or blogging in general, but I knew I needed some way for posts to
get ingested. I also knew I wanted to easily be able to submit a post to twitter,
fb, hacker news and the like. I also wanted a pretty single page app experience.
How would I go about getting both? I needed to look at a real world example to
make sure I was going about this the right way.</p>
<p>After some thought I decided I would organize posts into numeric txt files in groups of</p>
<ol>
<li>I&#39;d have a main template which would get updated with the &quot;latest&quot; group of 10. But
as you scrolled it would grab the next group of 10 and their associated snippets.</li>
</ol>
<p>Things just got more complex. Before I started automating all of this with gulp, I really
needed to lock down some client code to make sure it was in fact what I wanted. At this point,
my knee jerk reaction said - hey this is a great time to checkout react. And so I did.</p>
<h2 id="taking-some-time-to-think-about-the-experience-with-reactjs-">Taking some time to think about the experience with ReactJS.</h2>
<p>Everything in React is components. Which I like. So now let&#39;s take a moment to think through
what components this blog will have. My initial thoughts looked like this:</p>
<ul>
<li>Main Scroll List of Posts - displays N post summaries at a time and lets us scroll through and load more on scroll end</li>
<li>Post Summary Card
<strong> Title
</strong> Snippet</li>
<li>Full Post View (this should be a single page)
<strong> Title
</strong> Body</li>
<li>Tweets side bar
** Tweet</li>
<li>Instapaper side bar
** Headline</li>
</ul>
<p>That seems pretty easy. For Models, we&#39;ll likely use Backbone and potentially some Browserify
because I like my js node-like. Quick shout out to (Tyler McGinnis)[<a href="http://tylermcginnis.com/">http://tylermcginnis.com/</a>] who wrote
(this)[<a href="http://tylermcginnis.com/reactjs-tutorial-a-comprehensive-guide-to-building-apps-with-react/">http://tylermcginnis.com/reactjs-tutorial-a-comprehensive-guide-to-building-apps-with-react/</a>] very
awesome tutorial on React which I used to accumulate my current (paltry) knowledge. Bear in mind I haven&#39;t
done anything in the web front-end world in a while so bear with me.</p>
<h2 id="flexing">Flexing</h2>
<p>I&#39;ve never really loved css layouts. I don&#39;t think anyone ever has. That said, flexbox is finally a css layout
scheme I can both grok and get behind. So, given the layout above, I came up with the following flexbox layout
using node sass compiled it down to a template.</p>
<pre><code class="lang-css"><div class="highlight"><pre><span class="nt">test</span>
</pre></div>

</code></pre>
<p>With a really basic html skeleton:</p>
<pre><code class="lang-html"><div class="highlight"><pre>test
</pre></div>

</code></pre>
<h2 id="moar-au-tomatoe-ating">Moar au-tomatoe-ating</h2>
<p>This let me see that I had the basic blocks I was looking for. After fiddling
with this a bit I decided I needed to extend my gulp file to handle some of the
repetitive tasks I&#39;d been dealing with. As I worked on the sass + html, I found
myself constantly forgetting to compile + refresh my workspace. So, I decided
to take care of that and extended my gulp file with a new watch and auto-reload
express web app and gulp-sass for compilation. This was also a much needed break
from fiddling with CSS properties. :/</p>
<p>To do this we do some new installs:</p>
<pre><code><div class="highlight"><pre><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">express</span> <span class="o">--</span><span class="nx">save</span><span class="o">-</span><span class="nx">dev</span>
</pre></div>

</code></pre><p>Express will be our web framework. We&#39;ll write it up as part of our default task
and have it serve our ./dist directory and also make it a pre-req for our default
task.</p>
<pre><code><div class="highlight"><pre><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;serve&#39;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;lib/**/*.js&#39;</span><span class="p">,[</span><span class="s1">&#39;test&#39;</span><span class="p">]);</span>
    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;tests/**/*.js&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]);</span>
    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;raws/**/*.md&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;build_content&#39;</span><span class="p">]);</span>
    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;template/**/*.scss&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;compile_sass&#39;</span><span class="p">]);</span>
    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;template/**/*.*&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;reload&#39;</span><span class="p">]);</span>
<span class="p">});</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;serve&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">&#39;./dist&#39;</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8000</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre><p>Now if I navigate to <a href="http://localhost:8000/buildingthisblog">http://localhost:8000/buildingthisblog</a> I see the latest
transformed post via index.html. Cool. But now I need some more watchers and
I need the site to auto reload anytime I modify stuff.</p>
<p>For this we&#39;ll need connect-livereload and tinylr. Which we can also install:</p>
<pre><code><div class="highlight"><pre><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">connect</span><span class="o">-</span><span class="nx">livereload</span> <span class="nx">tiny</span><span class="o">-</span><span class="nx">lr</span> <span class="o">--</span><span class="nx">save</span><span class="o">-</span><span class="nx">dev</span>
</pre></div>

</code></pre><p>We&#39;ll add these to our gulpfile and modify express to receive connect-livereload
as middleware:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">lrserver</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;tiny-lr&#39;</span><span class="p">)();</span>

<span class="kd">var</span> <span class="nx">EXPRESS_PORT</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">EXPRESS_ROOT</span> <span class="o">=</span> <span class="s1">&#39;./dist&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">LIVERELOAD_PORT</span> <span class="o">=</span> <span class="mi">35729</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;connect-livereload&#39;</span><span class="p">)());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">EXPRESS_ROOT</span><span class="p">));</span>
</pre></div>

</code></pre>
<p>We then modify the serve task:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;serve&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">lrserver</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">LIVERELOAD_PORT</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">EXPRESS_PORT</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>Last, we add a function for refreshing. This will again leverage the through2
signature:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">notifyLivereload</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">enc</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">lrserver</span><span class="p">.</span><span class="nx">changed</span><span class="p">({</span>
        <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">files</span><span class="o">:</span> <span class="p">[</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
    <span class="nx">cb</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>Now, where ever we make a change that should refresh the browser, we can add a:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre>     <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">notifyLivereload</span><span class="p">));</span>
</pre></div>

</code></pre>
<p>We&#39;ll add that to some new tasks: sass and cp as well as build_content.</p>
<p>Disclaimer: there is also a
plugin called gulp-livereload which seems to be set up to do this for us, however
my first run with proved unsuccessful, so I rolled my own steam processor with
through2. I may just have missed something.</p>
<p>For sass and cp, I want to create task for handling sass compilation to css and
 a task that will copy any modified html templates to dist. We also install gulp-sass for
 handling sass compilation.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre> <span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;sass&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
     <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;./template/*.scss&#39;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sass</span><span class="p">())</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">EXPRESS_ROOT</span><span class="p">))</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">notifyLivereload</span><span class="p">));</span>
 <span class="p">});</span>

 <span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
     <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;./template/*.html&#39;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">EXPRESS_ROOT</span><span class="p">))</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">notifyLivereload</span><span class="p">));</span>
 <span class="p">});</span>
</pre></div>

</code></pre>
<p> And some new watchers:</p>
<pre><code class="lang-javascript"><div class="highlight"><pre>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;template/**/*.scss&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;sass&#39;</span><span class="p">]);</span>
    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;template/**/*.html&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">]);</span>
</pre></div>

</code></pre>
<h2 id="gulpfile-2-0">Gulpfile 2.0</h2>
<p>Okay, it&#39;s been a while and our gulpfile has grown a bit since we last looked.
Let&#39;s get another snapshot before diving back into our adventures with css and
flexbox and making a beautiful template for a beautiful blog.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre> <span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp&#39;</span><span class="p">);</span>
 <span class="kd">var</span> <span class="nx">mocha</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-mocha&#39;</span><span class="p">);</span>
 <span class="kd">var</span> <span class="nx">rename</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-rename&#39;</span><span class="p">);</span>
 <span class="kd">var</span> <span class="nx">through2</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;through2&#39;</span><span class="p">);</span>
 <span class="kd">var</span> <span class="nx">md2post</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/md2post.js&#39;</span><span class="p">);</span>
 <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
 <span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
 <span class="kd">var</span> <span class="nx">sass</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gulp-sass&#39;</span><span class="p">);</span>
 <span class="kd">var</span> <span class="nx">lrserver</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;tiny-lr&#39;</span><span class="p">)();</span>

 <span class="kd">var</span> <span class="nx">EXPRESS_PORT</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
 <span class="kd">var</span> <span class="nx">EXPRESS_ROOT</span> <span class="o">=</span> <span class="s1">&#39;./dist&#39;</span><span class="p">;</span>
 <span class="kd">var</span> <span class="nx">LIVERELOAD_PORT</span> <span class="o">=</span> <span class="mi">35729</span><span class="p">;</span>

 <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
 <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;connect-livereload&#39;</span><span class="p">)());</span>
 <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">EXPRESS_ROOT</span><span class="p">));</span>


 <span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
     <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;tests/**/*.js&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">read</span><span class="o">:</span> <span class="kc">false</span><span class="p">})</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">mocha</span><span class="p">({</span><span class="nx">reporter</span><span class="o">:</span> <span class="s1">&#39;nyan&#39;</span><span class="p">}));</span>
 <span class="p">});</span>

 <span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;build_content&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
     <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;raws/**/*.md&#39;</span><span class="p">)</span>
         <span class="c1">// tap into the stream to get each file&#39;s data</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">processMdFiles</span><span class="p">))</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="nx">newPath</span><span class="p">))</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">EXPRESS_ROOT</span><span class="p">))</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">notifyLivereload</span><span class="p">));</span>
 <span class="p">});</span>

 <span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;serve&#39;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
     <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;lib/**/*.js&#39;</span><span class="p">,[</span><span class="s1">&#39;test&#39;</span><span class="p">]);</span>
     <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;tests/**/*.js&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]);</span>
     <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;raws/**/*.md&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;build_content&#39;</span><span class="p">]);</span>
     <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;template/**/*.scss&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;sass&#39;</span><span class="p">]);</span>
     <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;template/**/*.html&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">]);</span>

 <span class="p">});</span>

 <span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;serve&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
     <span class="nx">lrserver</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">LIVERELOAD_PORT</span><span class="p">);</span>
     <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">EXPRESS_PORT</span><span class="p">);</span>
 <span class="p">});</span>


 <span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;sass&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
     <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;./template/*.scss&#39;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sass</span><span class="p">())</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">EXPRESS_ROOT</span><span class="p">))</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">notifyLivereload</span><span class="p">));</span>
 <span class="p">});</span>

 <span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
     <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;./template/*.html&#39;</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">EXPRESS_ROOT</span><span class="p">))</span>
         <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">through2</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">notifyLivereload</span><span class="p">));</span>
 <span class="p">});</span>

 <span class="kd">function</span> <span class="nx">newPath</span><span class="p">(</span><span class="nx">pathObj</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">pathObj</span><span class="p">.</span><span class="nx">dirname</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">pathObj</span><span class="p">.</span><span class="nx">dirname</span><span class="p">,</span> <span class="nx">pathObj</span><span class="p">.</span><span class="nx">basename</span><span class="p">);</span>
     <span class="nx">pathObj</span><span class="p">.</span><span class="nx">basename</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">;</span>
     <span class="nx">pathObj</span><span class="p">.</span><span class="nx">extname</span> <span class="o">=</span> <span class="s2">&quot;.html&quot;</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="kd">function</span> <span class="nx">processMdFiles</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">enc</span><span class="p">,</span> <span class="nx">cb</span><span class="p">){</span>
     <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">md2post</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
     <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">){</span>
         <span class="nx">chunk</span><span class="p">.</span><span class="nx">contents</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">);</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
         <span class="nx">cb</span><span class="p">();</span>
     <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
 <span class="p">}</span>

 <span class="kd">function</span> <span class="nx">notifyLivereload</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">enc</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
     <span class="nx">lrserver</span><span class="p">.</span><span class="nx">changed</span><span class="p">({</span>
         <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
             <span class="nx">files</span><span class="o">:</span> <span class="p">[</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span>
         <span class="p">}</span>
     <span class="p">});</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
     <span class="nx">cb</span><span class="p">();</span>
 <span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="refining-the-templates-aka-more-html-and-css-gah-">Refining the templates (aka more html and css gah :/ )</h2>
